<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="workitem-details-template-version" content="1.1.0"/>
  <style>
    html,body{height:100%}
    body{margin:0;background:#fff;font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif;color:#111827;height:100%}
    .wrap{padding:0;height:100%}
    .drawer{width:100%;max-width:100%;margin:0;border-radius:0;box-shadow:none;height:100%}
    .crumb{padding:8px 24px;border-bottom:1px solid #f0f0f0;background:#fff;display:flex;align-items:center;gap:8px}
    .crumb-link{color:#2563EB;text-decoration:none}
    .crumb-link:hover{text-decoration:underline}
    .crumb-current{color:#111827;font-weight:600}
    .crumb-sep{color:#6B7280}
    .header{padding:16px 24px;border-bottom:1px solid #f0f0f0;background:#fff;display:flex;align-items:center;gap:10px}
    .id{color:#6B7280;font-weight:600}
    .title{font-size:18px;font-weight:700}
    .quick{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:8px 24px;border-bottom:1px solid #f0f0f0;background:#fff}
    .quick .item{display:flex;flex-direction:column;gap:6px}
    .quick .label{color:#6B7280}
    .quick .value{font-weight:600}
    .base-info{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding-top:4px}
    .base-info .item{display:flex;flex-direction:column;gap:6px}
    .base-info .label{color:#6B7280}
    .base-info .value{font-weight:600}
    .layout{display:grid;grid-template-columns:1fr;gap:16px;padding:16px 24px;background:#fff}
    .section-title{font-size:16px;font-weight:700;margin:12px 0 8px}
    .desc-card,.sketch-card,.comments-card{border:1px solid #f0f0f0;border-radius:8px;padding:12px;background:#fff}
    .ant-descriptions-item-label{color:#6B7280}
    .tag{display:inline-block;margin:0 8px 8px 0}
    .ant-tag{display:inline-block;border:1px solid #D1D5DB;border-radius:999px;padding:2px 8px;background:#F9FAFB;color:#374151;font-size:12px}
    .ant-tag-pink{border-color:#FDA4AF;background:#FFE4E6;color:#9D174D}
    .comment-item{border-bottom:1px solid #f0f0f0;padding:12px 0}
    .comment-item:last-child{border-bottom:none}
    .comment-row{display:flex;align-items:flex-start;gap:10px}
    .comment-avatar{flex:0 0 24px}
    .comment-main{flex:1 1 auto}
    .comment-meta{color:#6B7280;margin-bottom:6px;font-size:12px}
    .comment-time{background:#F3F4F6;border:1px solid #E5E7EB;border-radius:999px;padding:2px 8px}
    .comment-avatar .ant-avatar{width:24px;height:24px;line-height:24px}
    .comment-avatar img{width:24px;height:24px;border-radius:50%;object-fit:cover}
    .comment-body img{max-width:300px;height:auto}
    .comment-attachment img{max-width:100%;height:auto}
    .badge{display:inline-block;border:1px solid #D1D5DB;border-radius:999px;padding:2px 8px;background:#F3F4F6;color:#374151}
    .state-badge{min-width:70px;display:inline-block;text-align:center}
    .state-badge.state-inprogress{background:#F59E0B;color:#fff;border-color:#FDBA74}
    .state-badge.state-testable{background:#3B82F6;color:#fff;border-color:#93C5FD}
    .state-badge.state-testing{background:#A855F7;color:#fff;border-color:#C4B5FD}
    .state-badge.state-done{background:#10B981;color:#fff;border-color:#6EE7B7}
    .state-badge.state-closed{background:#9CA3AF;color:#fff;border-color:#D1D5DB}
    .state-badge.state-pending{background:#E5E7EB;color:#374151;border-color:#D1D5DB}
    .ant-comment-avatar .ant-avatar{width:24px;height:24px;line-height:24px}
    .ant-comment-avatar img{width:24px;height:24px;border-radius:50%}
    .ant-comment-content-detail img,.desc-card img,.sketch-card img{max-width:100%;border-radius:8px;border:1px solid #E5E7EB}
    .ant-comment-content-detail pre, .ant-comment-content-detail code{background:#F7F7F9;border:1px solid #E5E7EB;border-radius:6px}
    .ant-comment-content-detail pre{padding:10px;overflow:auto}
    .ant-comment-content-detail code{padding:2px 4px}
    .comment-editor{border:1px solid #E5E7EB;border-radius:8px;padding:8px;margin-bottom:12px;background:#FAFAFA}
    .comment-collapsed{display:flex;align-items:center;gap:8px}
    .comment-collapsed input{flex:1 1 auto;padding:8px 10px;border:1px solid #D1D5DB;border-radius:6px}
    .comment-expanded{display:none}
    .edit-area{min-height:180px;border:1px solid #D1D5DB;border-radius:6px;padding:8px;background:#fff;overflow:auto}
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .toolbar .tips{color:#6B7280;font-size:12px}
    .actions{display:flex;gap:8px;margin-top:8px}
    .actions button{padding:6px 12px;border:1px solid #D1D5DB;border-radius:6px;background:#fff;cursor:pointer}
    .actions button:hover{background:#F3F4F6}
  </style>
  <title>工作项详情</title>
  </head>
<body>
  <div class="wrap">
    <div class="ant-drawer ant-drawer-open ant-drawer-right">
      <div class="ant-drawer-content-wrapper drawer">
        <div class="ant-drawer-content">
          <div class="ant-drawer-wrapper-body">
            <div class="ant-drawer-body" style="padding:0;height:100%;overflow:auto">
              <div class="crumb">{{ParentCrumbHtml}}</div>
              <div class="header"><span class="id">{{Identifier}}</span><span class="title">{{Title}}</span></div>
              <div class="quick">
                <div class="item"><div class="label">负责人</div><div class="value">{{AssigneeName}}</div></div>
                <div class="item"><div class="label">状态</div><div class="value"><select id="stateSelect" style="width:160px;padding:4px;border:1px solid #D1D5DB;border-radius:6px"><option selected>{{StateName}}</option></select></div></div>
                <div class="item"><div class="label">开始时间</div><div class="value">{{StartAt}}</div></div>
                <div class="item"><div class="label">结束时间</div><div class="value">{{EndAt}}</div></div>
              </div>
              <div class="layout">
                <div>
                  <div class="section-title">基本信息</div>
                  <div class="base-info">
                    <div class="item"><div class="label">优先级</div><div class="value"><span class="badge">{{PriorityName}}</span></div></div>
                    <div class="item"><div class="label">严重程度</div><div class="value">{{SeverityText}}</div></div>
                    <div class="item"><div class="label">故事点</div><div class="value">
                      <input id="spInput" type="number" min="0" step="0.01" style="width:120px;padding:4px;border:1px solid #D1D5DB;border-radius:6px" value="{{StoryPointsInput}}">
                    </div></div>
                    <div class="item"><div class="label">所属产品</div><div class="value">{{ProductName}}</div></div>
                    <div class="item"><div class="label">缺陷类别</div><div class="value">{{DefectCategory}}</div></div>
                    <div class="item"><div class="label">复现版本号</div><div class="value">{{ReproduceVersion}}</div></div>
                    <div class="item"><div class="label">复现概率</div><div class="value">{{ReproduceProbability}}</div></div>
                    <div class="item"><div class="label">故事点汇总</div><div class="value">{{StoryPointsSum}}</div></div>
                  </div>
                  <div class="section-title">标签</div>
                  <div>{{TagsHtml}}</div>
                  <div class="section-title">描述</div>
                  <div class="desc-card">{{DescriptionHtml}}</div>
                  <div class="section-title">示意图</div>
                  <div class="sketch-card">{{SketchHtml}}</div>
                  <div class="section-title">评论</div>
                  <div class="comments-card">{{CommentsHtml}}</div>
                  <div class="comment-editor" id="commentEditor">
                    <div id="commentCollapsed" class="comment-collapsed">
                      <input id="commentCollapsedInput" type="text" placeholder="添加评论..."/>
                    </div>
                    <div id="commentExpanded" class="comment-expanded">
                      <div id="commentEdit" class="edit-area" contenteditable="true"></div>
                      <div class="toolbar">
                        <span class="tips">Ctrl+Enter 提交</span>
                      </div>
                      <div id="attachmentsPreview" class="attachments-preview" style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px 0;"></div>
                      <div class="actions">
                        <button id="commentSubmitBtn" type="button">提交</button>
                        <button id="commentCancelBtn" type="button">取消</button>
                      </div>
                    </div>
                  </div>
                </div>
                
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
  (function(){
    function parseVal(v){
      try{
        var n=parseFloat(v);
        if(isNaN(n)||n<0){return 0;}
        return n;
      }catch(e){return 0;}
    }
    window.pendingAttachments=[];
    function addAttachment(url){
      try{
        if(!url){return;}
        var u=(url||'').trim();
        if(!u){return;}
        var list=window.pendingAttachments||(window.pendingAttachments=[]);
        if(list.indexOf(u)>=0){return;}
        list.push(u);
        var pre=document.getElementById('attachmentsPreview');
        if(pre){
          var img=document.createElement('img');
          img.src=u;
          img.alt='image';
          img.style.maxWidth='120px';
          img.style.maxHeight='90px';
          img.style.objectFit='contain';
          img.style.border='1px solid #e5e5e5';
          img.style.borderRadius='4px';
          pre.appendChild(img);
        }
        scrollToBottomDeferred();
      }catch(e){}
    }
    window.addAttachment=addAttachment;
    function scrollToBottom(){
      try{
        var body=document.querySelector('.ant-drawer-body');
        var expanded=document.getElementById('commentExpanded');
        var submit=document.getElementById('commentSubmitBtn');
        var cancel=document.getElementById('commentCancelBtn');
        var editor=document.getElementById('commentEditor');
        var target=submit||cancel||expanded||editor;
        if(target&&target.scrollIntoView){ target.scrollIntoView({block:'end'}); }
        if(body&&typeof body.scrollTo==='function'){ body.scrollTo({top: body.scrollHeight}); }
        else if(body){ body.scrollTop=body.scrollHeight; }
        var sc=document.scrollingElement||document.documentElement;
        if(sc){ sc.scrollTop=sc.scrollHeight; } else { window.scrollTo(0, (document.documentElement&&document.documentElement.scrollHeight)||document.body.scrollHeight); }
      }catch(e){}
    }
    function scrollToBottomDeferred(){
      try{
        if(window.requestAnimationFrame){
          window.requestAnimationFrame(function(){ window.requestAnimationFrame(scrollToBottom); });
        }else{
          setTimeout(scrollToBottom,30);
        }
      }catch(e){}
    }
    function save(){
      try{
        var ip=document.getElementById('spInput');
        if(!ip){return;}
        var val=parseVal(ip.value);
        if(window.chrome&&window.chrome.webview){
          window.chrome.webview.postMessage({type:'updateStoryPoints', id:'{{WorkItemId}}', value:val});
        }
      }catch(e){}
    }
    function onStateChange(){
      try{
        var sel=document.getElementById('stateSelect');
        var val=sel&&sel.value;
        if(val&&window.chrome&&window.chrome.webview){
          window.chrome.webview.postMessage({type:'updateState', id:'{{WorkItemId}}', stateId:val});
        }
      }catch(e){}
    }
    try{
      var ip=document.getElementById('spInput');
      if(ip){
        ip.addEventListener('blur', save);
        ip.addEventListener('keydown', function(e){ if(e.key==='Enter'){ save(); } });
      }
      var sel=document.getElementById('stateSelect');
      if(sel){
        sel.addEventListener('change', onStateChange);
      }
      var collapsed=document.getElementById('commentCollapsed');
      var collapsedInput=document.getElementById('commentCollapsedInput');
      var expanded=document.getElementById('commentExpanded');
      var edit=document.getElementById('commentEdit');
      var submitBtn=document.getElementById('commentSubmitBtn');
      var cancelBtn=document.getElementById('commentCancelBtn');
      var insertImgBtn=document.getElementById('insertImageLinkBtn');
      function expandEditor(){
        if(collapsed&&expanded){
          collapsed.style.display='none';
          expanded.style.display='block';
        }
        try{
          var pre=document.getElementById('attachmentsPreview');
          if(pre){ pre.innerHTML=''; }
          if(window.pendingAttachments){ window.pendingAttachments=[]; }
        }catch(e){}
        if(edit){ edit.focus(); }
        if(collapsedInput&&edit&&collapsedInput.value){
          edit.innerText=collapsedInput.value;
          collapsedInput.value='';
        }
        scrollToBottomDeferred();
      }
      function collapseEditor(){
        if(collapsed&&expanded){
          expanded.style.display='none';
          collapsed.style.display='flex';
        }
        if(edit){ edit.innerHTML=''; }
        try{
          var pre=document.getElementById('attachmentsPreview');
          if(pre){ pre.innerHTML=''; }
          if(window.pendingAttachments){ window.pendingAttachments=[]; }
        }catch(e){}
      }
      function submitComment(){
        try{
          var text=(edit&&edit.innerText||'').trim();
          var list=window.pendingAttachments||[];
          if(!text && list.length===0){ return; }
          if(window.chrome&&window.chrome.webview){
            window.chrome.webview.postMessage({type:'submitComment', id:'{{WorkItemId}}', content:text, attachments: list.slice(0)});
          }
          scrollToBottom();
        }catch(e){}
      }
      if(collapsedInput){
        collapsedInput.addEventListener('focus', expandEditor);
        collapsedInput.addEventListener('click', expandEditor);
      }
      if(cancelBtn){
        cancelBtn.addEventListener('click', collapseEditor);
      }
      if(submitBtn){
        submitBtn.addEventListener('click', submitComment);
      }
      if(edit){
        edit.addEventListener('keydown', function(e){
          if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ submitComment(); }
        });
        edit.addEventListener('paste', function(e){
          try{
            var items=(e.clipboardData&&e.clipboardData.items)||[];
            var handled=false;
            for(var i=0;i<items.length;i++){
              var it=items[i];
              if(it&&it.type&&it.type.indexOf('image/')===0){
                var file=it.getAsFile();
                if(file){
                  var reader=new FileReader();
                  reader.onload=function(evt){
                    try{
                      var url=evt.target.result;
                      if(url){
                        if(window.chrome&&window.chrome.webview){
                          var localId='local_'+Math.random().toString(36).substr(2,9);
                          window.chrome.webview.postMessage({type:'uploadImageData', id:'{{WorkItemId}}', localId: localId, dataUrl: url, contentType: file.type});
                        }
                      }
                    }catch(ex){}
                  };
                  reader.readAsDataURL(file);
                  handled=true;
                }
              }
            }
            if(handled){ e.preventDefault(); }
          }catch(ex){}
        });
      }
    }catch(e){}
  })();
</script>
</body>
</html>
